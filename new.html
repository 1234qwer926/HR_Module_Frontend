<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Procurement Tracker</title>
    <style>
        :root {
            --bg: #f8fafc;
            --card: #fff;
            --accent: #1a73e8;
            --muted: #64748b;
            --danger: #ef4444;
        }

        body {
            font-family: 'Inter', Segoe UI, Arial, sans-serif;
            margin: 0;
            background: var(--bg);
            color: #1e293b;
        }

        .wrap {
            max-width: 960px;
            margin: 20px auto;
            padding: 24px;
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        h1 {
            margin: 0;
            font-size: 26px;
            color: var(--accent);
        }

        .logout-btn {
            padding: 8px 16px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            padding: 12px 20px;
            border-radius: 10px 10px 0 0;
            background: #e0e7ff;
            color: var(--accent);
            font-weight: 600;
            cursor: pointer;
        }

        .tab.active {
            background: var(--accent);
            color: white;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
            font-size: 14px;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid #cbd5e1;
            font-size: 15px;
            box-sizing: border-box;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.15);
        }

        textarea {
            resize: vertical;
            min-height: 90px;
        }

        .full {
            grid-column: 1/-1;
        }

        .actions {
            display: flex;
            gap: 14px;
            margin-top: 20px;
        }

        .btn {
            padding: 13px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 15px;
        }

        .btn.primary {
            background: var(--accent);
            color: white;
        }

        .btn.ghost {
            background: #f1f5f9;
            color: var(--accent);
            border: 1px solid #cbd5e1;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .small {
            font-size: 13px;
            margin-top: 10px;
            padding: 8px 0;
        }

        .success {
            color: #15803d;
            background: #f0fdf4;
            padding: 12px;
            border-radius: 10px;
        }

        .error {
            color: #b91c1c;
            background: #fef2f2;
            padding: 12px;
            border-radius: 10px;
        }

        .datalist-suggestions {
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            max-height: 200px;
            overflow: auto;
            margin-top: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
            display: none;
            position: absolute;
            z-index: 100;
            width: 100%;
        }

        .suggestion-item {
            padding: 12px 16px;
            cursor: pointer;
            border-radius: 8px;
        }

        .suggestion-item:hover {
            background: #f0f7ff;
        }

        @media(max-width:768px) {
            .grid {
                grid-template-columns: 1fr
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="wrap">
        <div class="header">
            <h1>Procurement Tracker</h1>
            <button class="logout-btn" onclick="google.script.run.logoutUser();location.reload()">Logout</button>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="tab-pr">New Requisition</div>
            <div class="tab" data-tab="tab-po">PO Update</div>
            <div class="tab" data-tab="tab-grn">GRN Update</div>
        </div>

        <div id="tab-pr" class="panel">
            <div class="grid">
                <div><label>Location</label><select id="pr-location" required>
                        <option value="">Select</option>
                        <option>PNS</option>
                        <option>Roorkee</option>
                        <option>CCMB</option>
                        <option>PARC</option>
                        <option>HO</option>
                    </select></div>
                <div><label>Category</label><select id="pr-category" required>
                        <option value="">Select</option>
                        <option>HR & House keeping</option>
                        <option>IT</option>
                        <option>Engineering & Maintenance</option>
                        <option>QC</option>
                        <option>Projects - Material</option>
                        <option>Projects - Equipment</option>
                        <option>R&D - Material</option>
                        <option>R&D - Equipment</option>
                    </select></div>
                <div class="full"><label>Material / Equipment</label><input id="pr-material" required
                        placeholder="e.g. Compressor Motor"></div>
                <div><label>Equipment ID (optional)</label><input id="pr-equipment" placeholder="e.g. EQP-001"></div>
                <div><label>Remarks (optional)</label><input id="pr-remarks" placeholder="Justification"></div>
                <div class="full"><label>Specifications</label><textarea id="pr-specs" required></textarea></div>
                <div><label>UOM</label><select id="pr-uom" required>
                        <option value="">Select</option>
                        <option>Nos</option>
                        <option>Kg</option>
                        <option>Litre</option>
                        <option>Set</option>
                        <option>Box</option>
                    </select></div>
                <div><label>Quantity</label><input id="pr-qty" type="number" min="1" required></div>
                <div class="full actions">
                    <button id="pr-submit" class="btn primary">Submit Requisition</button>
                    <button id="pr-reset" class="btn ghost">Reset</button>
                </div>
                <div class="full small" id="pr-msg"></div>
            </div>
        </div>

        <div id="tab-po" class="panel" style="display:none">
            <div class="grid">
                <div class="full">
                    <label>Search PR ID</label>
                    <input id="po-search" placeholder="e.g. 023">
                    <div id="po-suggestions" class="datalist-suggestions"></div>
                </div>
                <div><label>User Approval</label><select required id="po-user-approval">
                        <option value="">Select</option>
                        <option>Approved</option>
                        <option>Pending</option>
                        <option>Rejected</option>
                    </select></div>
                <div><label>PR Approval</label><select required id="po-pr-approval">
                        <option value="">Select</option>
                        <option>Approved</option>
                        <option>Pending</option>
                        <option>Rejected</option>
                    </select></div>
                <div><label>Commercial Approval</label><select required id="po-commercial-approval">
                        <option value="">Select</option>
                        <option>Approved</option>
                        <option>Pending</option>
                        <option>Rejected</option>
                    </select></div>
                <div><label>PO Number</label><input required id="po-number"></div>
                <div><label>PO Date</label><input required id="po-date" type="date"></div>
                <div><label>Payment Terms</label>
                    <select required id="payment-terms">
                        <option value="">Select</option>
                        <option>Immediate (100% advance)</option>
                        <option>15 Days Credit</option>
                        <option>30 Days Credit</option>
                        <option>45 Days Credit</option>
                        <option>50% Advance + 50% on Delivery</option>
                        <option>25% Advance + 75% on Delivery</option>
                        <option>100% on Delivery</option>
                        <option>LC / BG</option>
                    </select>
                </div>
                <div><label>Advance %</label><input required id="advance-percent" readonly></div>
                <div><label>Payment Due Date</label><input required id="payment-due-date" type="date"></div>
                <div><label>Material Schedule Date</label><input required id="mat-schedule" type="date"></div>
                <div class="full actions">
                    <button id="po-submit" class="btn primary">Update PO</button>
                    <button id="po-reset" class="btn ghost">Reset</button>
                </div>
                <div class="full small" id="po-msg"></div>
            </div>
        </div>

        <div id="tab-grn" class="panel" style="display:none">
            <div class="grid">
                <div class="full">
                    <label>Search PR ID</label>
                    <input id="grn-search" placeholder="e.g. 023">
                    <div id="grn-suggestions" class="datalist-suggestions"></div>
                </div>
                <div><label>GRN Quantity</label><input id="grn-qty" type="number" step="any" min="0.001" required></div>
                <div><label>GRN Date</label><input id="grn-date" type="date" required></div>
                <div class="full actions">
                    <button id="grn-submit" class="btn primary">Submit GRN</button>
                    <button id="grn-reset" class="btn ghost">Reset</button>
                </div>
                <div class="full small" id="grn-msg"></div>
            </div>
        </div>
    </div>

    <script>
        // Tab switching
        document.querySelectorAll('.tab').forEach(t => t.onclick = () => {
            document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.style.display = 'none');
            t.classList.add('active');
            document.getElementById(t.dataset.tab).style.display = 'block';
        });

        // Payment terms auto-fill
        const paymentTermsMap = {
            "Immediate (100% advance)": { advance: 100, dueDays: 0 },
            "15 Days Credit": { advance: 0, dueDays: 15 },
            "30 Days Credit": { advance: 0, dueDays: 30 },
            "45 Days Credit": { advance: 0, dueDays: 45 },
            "50% Advance + 50% on Delivery": { advance: 50, dueOnDelivery: true },
            "25% Advance + 75% on Delivery": { advance: 25, dueOnDelivery: true },
            "100% on Delivery": { advance: 0, dueOnDelivery: true },
            "LC / BG": { advance: 0 }
        };
        document.getElementById('payment-terms').onchange = function () {
            const config = paymentTermsMap[this.value] || {};
            document.getElementById('advance-percent').value = config.advance !== undefined ? config.advance + "%" : "";
            const poDate = document.getElementById('po-date').value;
            const schDate = document.getElementById('mat-schedule').value;
            if (poDate && config.dueDays > 0) {
                const d = new Date(poDate); d.setDate(d.getDate() + config.dueDays);
                document.getElementById('payment-due-date').value = d.toISOString().slice(0, 10);
            } else if (config.dueOnDelivery && schDate) {
                document.getElementById('payment-due-date').value = schDate;
            } else {
                document.getElementById('payment-due-date').value = "";
            }
        };
        document.getElementById('po-date').onchange =
            document.getElementById('mat-schedule').onchange = () => document.getElementById('payment-terms').dispatchEvent(new Event('change'));

        // Search functions
        function setupSearch(inputId, suggestionsId, callback) {
            const input = document.getElementById(inputId);
            const box = document.getElementById(suggestionsId);
            input.oninput = () => {
                clearTimeout(window.st); box.innerHTML = ''; box.style.display = 'none';
                if (input.value.length < 2) return;
                window.st = setTimeout(() => {
                    google.script.run.withSuccessHandler(ids => {
                        if (!ids?.length) return;
                        box.style.display = 'block';
                        ids.forEach(id => {
                            const div = document.createElement('div'); div.className = 'suggestion-item'; div.textContent = id;
                            div.onclick = () => { input.value = id; box.style.display = 'none'; callback(id); };
                            box.appendChild(div);
                        });
                    }).searchIDs(input.value);
                }, 300);
            };
        }
        setupSearch('po-search', 'po-suggestions', id => google.script.run.withSuccessHandler(fillPO).fetchPRDetails(id));
        setupSearch('grn-search', 'grn-suggestions', id => google.script.run.withSuccessHandler(d => document.getElementById('grn-msg').innerHTML = `<div class="success">Loaded: ${d.id}</div>`).fetchPRDetails(id));

        function fillPO(d) {
            if (!d) return document.getElementById('po-msg').innerHTML = '<div class="error">Not found</div>';
            document.getElementById('po-msg').innerHTML = `<div class="success">Loaded: ${d.id}</div>`;
            document.getElementById('po-user-approval').value = d.userApproval || "";
            document.getElementById('po-pr-approval').value = d.prApproval || "";
            document.getElementById('po-commercial-approval').value = d.commercialApproval || "";
            document.getElementById('po-number').value = d.poNumber || "";
            document.getElementById('po-date').value = d.poDate || "";
            document.getElementById('payment-terms').value = d.paymentTerms || "";
            document.getElementById('advance-percent').value = d.advancePercent || "";
            document.getElementById('payment-due-date').value = d.paymentDueDate || "";
            document.getElementById('mat-schedule').value = d.materialScheduleDate || "";
            document.getElementById('payment-terms').dispatchEvent(new Event('change'));
        }

        // Submit handlers
        document.getElementById('pr-submit').onclick = () => {
            const btn = document.getElementById('pr-submit'); btn.disabled = true; btn.textContent = "Submitting...";
            const data = {
                location: document.getElementById('pr-location').value,
                category: document.getElementById('pr-category').value,
                material: document.getElementById('pr-material').value.trim(),
                specs: document.getElementById('pr-specs').value.trim(),
                uom: document.getElementById('pr-uom').value,
                qty: document.getElementById('pr-qty').value,
                equipmentId: document.getElementById('pr-equipment').value.trim(),
                remarks: document.getElementById('pr-remarks').value.trim()
            };
            google.script.run.withSuccessHandler(res => {
                document.getElementById('pr-msg').innerHTML = `<div class="success">PR Created: <strong>${res.id}</strong></div>`;
                setTimeout(() => location.reload(), 2000);
            }).submitRequisitionData(data);
        };

        document.getElementById('po-submit').onclick = () => {
            if (!document.getElementById('po-search').value.trim()) return alert("Enter PR ID");
            const btn = document.getElementById('po-submit'); btn.disabled = true; btn.textContent = "Saving...";
            google.script.run.withSuccessHandler(() => {
                document.getElementById('po-msg').innerHTML = '<div class="success">PO Updated!</div>';
                setTimeout(() => btn.disabled = false, 2000);
            }).submitPOData({
                id: document.getElementById('po-search').value.trim(),
                userApproval: document.getElementById('po-user-approval').value,
                prApproval: document.getElementById('po-pr-approval').value,
                commercialApproval: document.getElementById('po-commercial-approval').value,
                poNumber: document.getElementById('po-number').value,
                poDate: document.getElementById('po-date').value,
                paymentTerms: document.getElementById('payment-terms').value,
                advancePercent: document.getElementById('advance-percent').value,
                paymentDueDate: document.getElementById('payment-due-date').value,
                materialScheduleDate: document.getElementById('mat-schedule').value
            });
        };

        document.getElementById('grn-submit').onclick = () => {
            if (!document.getElementById('grn-search').value.trim()) return alert("Enter PR ID");
            const btn = document.getElementById('grn-submit'); btn.disabled = true;
            google.script.run.withSuccessHandler(res => {
                document.getElementById('grn-msg').innerHTML = `<div class="success">${res}</div>`;
            }).submitGRNData({
                id: document.getElementById('grn-search').value.trim(),
                grnQty: document.getElementById('grn-qty').value,
                grnDate: document.getElementById('grn-date').value
            });
        };

        document.querySelectorAll('#pr-reset,#po-reset,#grn-reset').forEach(b => b.onclick = () => location.reload());
    </script>
</body>

</html>